name: CI/CD Pipeline - Build, Push to ACR, Deploy to AKS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: rg-flipkart-app
  ACR_NAME: acrflipkartmobile225325332
  AKS_CLUSTER_NAME: aks-flipkart-cluster22325342
  IMAGE_NAME: flipkartmobilepage

permissions:
  contents: read
  checks: write
  id-token: write

jobs:
  # Job 1: CI Build and Test
  build-and-test:
    name: Build and Test .NET Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Restore dependencies
      run: dotnet restore FlipkartMobile.sln
      
    - name: Build
      run: dotnet build FlipkartMobile.sln --configuration Release --no-restore
      
    - name: Test
      run: dotnet test FlipkartMobile.sln --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
      # continue-on-error: true
      
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: .NET Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: false

  # Job 2: Docker Build and Push to ACR
  docker-build-push:
    name: Build Docker Image and Push to ACR
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate image tag
      id: image-tag
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "Image tag: ${SHORT_SHA}"
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create Azure Resource Group
      run: az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location eastus

    - name: Create Azure Container Registry
      run: az acr create --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.ACR_NAME }} --sku Basic --admin-enabled true

    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }} .
        docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }} ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
    
    - name: Push Docker image to ACR
      run: |
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
    
    - name: Verify image in ACR
      run: |
        az acr repository show --name ${{ env.ACR_NAME }} --repository ${{ env.IMAGE_NAME }}

  # Job 3: Deploy to AKS
  deploy-to-aks:
    name: Deploy to Azure Kubernetes Service
    runs-on: ubuntu-latest
    needs: docker-build-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    # - uses: azure/login@v2
    #   with:
    #     client-id: ${{ secrets.AZURE_CLIENT_ID }}
    #     tenant-id: ${{ secrets.AZURE_TENANT_ID }}
    #     subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    #     client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
    
    - name: Get AKS credentials
      run: |
        az aks get-credentials --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER_NAME }} --overwrite-existing
    
    - name: Update deployment manifest with new image tag
      run: |
        IMAGE_TAG=${{ needs.docker-build-push.outputs.image-tag }}
        sed -i "s|image:.*|image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG}|g" k8s/deployment.yaml
        cat k8s/deployment.yaml
    
    - name: Deploy to AKS
      run: |
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
    
    - name: Wait for deployment to complete
      run: |
        kubectl rollout status deployment/flipkartmobilepage-deployment --timeout=5m
    
    - name: Get deployment status
      run: |
        echo "=== Deployments ==="
        kubectl get deployments
        echo ""
        echo "=== Pods ==="
        kubectl get pods
        echo ""
        echo "=== Services ==="
        kubectl get services
    
    - name: Get application endpoint
      run: |
        echo "Waiting for external IP to be assigned..."
        sleep 30
        EXTERNAL_IP=$(kubectl get service flipkartmobilepage-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        if [ -z "$EXTERNAL_IP" ]; then
          echo "External IP not yet assigned. Check with: kubectl get service flipkartmobilepage-service"
        else
          echo "Application is accessible at: http://${EXTERNAL_IP}"
        fi
